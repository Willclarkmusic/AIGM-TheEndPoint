rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // USERS COLLECTION - Allow full access to own user document
    match /users/{userId} {
      allow read, write, create, update, delete: if isOwner(userId);
    }

    // Helper function to get user's role in a server
    function getUserRole(serverId, userId) {
      return get(/databases/$(database)/documents/servers/$(serverId)/members/$(userId)).data.role;
    }

    // Helper function to check if user is owner/admin of server
    function isServerOwnerOrAdmin(serverId, userId) {
      return isAuthenticated() && 
             (getUserRole(serverId, userId) in ['owner', 'admin']);
    }

    // Helper function to check if user is server owner
    function isServerOwner(serverId, userId) {
      return isAuthenticated() && 
             getUserRole(serverId, userId) == 'owner';
    }

    // Helper function to check if user is member of server
    function isServerMember(serverId, userId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/servers/$(serverId)/members/$(userId));
    }

    // SERVERS COLLECTION - Role-based access
    match /servers/{serverId} {
      // Allow authenticated users to read all servers (needed for join by code)
      allow read: if isAuthenticated();
      // Allow authenticated users to create servers
      allow create: if isAuthenticated();
      // Only owners can update server information
      allow update: if isServerOwner(serverId, request.auth.uid);
      // Only owners can delete servers
      allow delete: if isServerOwner(serverId, request.auth.uid);
      
      // SERVER MEMBERS SUBCOLLECTION - Role-based permissions
      match /members/{memberId} {
        // All members can read member list
        allow read: if isAuthenticated();
        // Allow users to join servers by creating member documents
        allow create: if isAuthenticated();
        // Members can leave (delete their own membership)
        // Owners/Admins can update roles and kick members (except other owners)
        allow update: if isAuthenticated() && 
                      (isServerOwnerOrAdmin(serverId, request.auth.uid) &&
                       resource.data.role != 'owner');
        allow delete: if isAuthenticated() && 
                      (request.auth.uid == memberId || 
                       (isServerOwnerOrAdmin(serverId, request.auth.uid) && 
                        resource.data.role != 'owner'));
      }
      
      // CHAT ROOMS SUBCOLLECTION - Role-based permissions
      match /chat_rooms/{roomId} {
        // All server members can read rooms
        allow read: if isServerMember(serverId, request.auth.uid);
        // Only owners/admins can create rooms
        allow create: if isServerOwnerOrAdmin(serverId, request.auth.uid);
        // Only owners/admins can update/delete rooms
        allow update, delete: if isServerOwnerOrAdmin(serverId, request.auth.uid);
        
        // MESSAGES SUBCOLLECTION
        match /messages/{messageId} {
          // Only server members can read messages
          allow read: if isServerMember(serverId, request.auth.uid);
          // Only server members can send messages
          allow create: if isServerMember(serverId, request.auth.uid);
          // Messages cannot be edited
          allow update: if false; 
          // Users can delete their own messages, owners/admins can delete any message
          allow delete: if isAuthenticated() && 
                       (resource.data.senderId == request.auth.uid ||
                        isServerOwnerOrAdmin(serverId, request.auth.uid));
        }
      }
    }

    // PRIVATE MESSAGES COLLECTION
    match /private_messages/{pmId} {
      allow read, write: if isAuthenticated() && 
                        request.auth.uid in resource.data.participants;
      allow create: if isAuthenticated() && 
                   request.auth.uid in request.resource.data.participants &&
                   request.resource.data.participants.size() <= 20;
      
      match /messages/{messageId} {
        allow read: if isAuthenticated() && 
                   request.auth.uid in get(/databases/$(database)/documents/private_messages/$(pmId)).data.participants;
        allow create: if isAuthenticated() && 
                     request.auth.uid in get(/databases/$(database)/documents/private_messages/$(pmId)).data.participants;
        allow update: if false;
        allow delete: if isAuthenticated() && resource.data.senderId == request.auth.uid;
      }
    }

    // AI AGENTS COLLECTION
    match /ai_agents/{agentId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && 
                           resource.data.creatorId == request.auth.uid;
    }

    // SOCIAL FEED COLLECTION
    match /social_feed/{postId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && 
                           resource.data.author == request.auth.uid;
    }

    // FRIEND REQUESTS COLLECTION
    match /friend_requests/{requestId} {
      allow read, write: if isAuthenticated();
      allow create: if isAuthenticated();
    }

    // Default allow for development - REMOVE IN PRODUCTION
    match /{document=**} {
      allow read, write: if isAuthenticated();
    }
  }
}